<!-- 1) Load SDK first (no defer/async) -->
<script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>

<script>
  const AUTH0_DOMAIN   = "dev-74ja1cuagr1s3c2c.us.auth0.com";
  const AUTH0_CLIENTID = "KvD2HPQsxFeOFIezMtdaAFlFtqBQST8m";
  const AUTH0_AUDIENCE = "https://calendar.yourgoalplanner.com/api";

  // make the client visible to the console for debugging
  window.auth0Client = null;

  // small helper to update the "SDK loaded" and status lines
  function set(id, txt, ok) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = txt;
    if (ok === true)  { el.classList.add('ok');  el.classList.remove('bad'); }
    if (ok === false) { el.classList.add('bad'); el.classList.remove('ok'); }
  }

  async function init() {
    // show whether the SDK global exists
    const sdkPresent = (typeof window.createAuth0Client === "function");
    set('sdk', sdkPresent ? 'yes' : 'no', sdkPresent);
    if (!sdkPresent) {
      console.error("SDK not ready");
      set('status', 'SDK not ready', false);
      return;
    }

    // create the Auth0 client
    window.auth0Client = await createAuth0Client({
      domain: AUTH0_DOMAIN,
      clientId: AUTH0_CLIENTID,
      authorizationParams: {
        audience: AUTH0_AUDIENCE,
        redirect_uri: window.location.origin + "/login.html"
      }
    });

    // complete the redirect if returning from Auth0
    if (location.search.includes("code=") || location.search.includes("state=")) {
      try {
        await window.auth0Client.handleRedirectCallback();
        history.replaceState({}, document.title, "/login.html");
      } catch (e) {
        console.error("handleRedirectCallback error:", e);
      }
    }

    const authed = await window.auth0Client.isAuthenticated();
    set('authed', String(authed), authed);
    set('status', authed ? 'You are logged in.' : 'You are logged out.', authed);

    // wire buttons
    document.getElementById("loginBtn").onclick  = () => window.auth0Client?.loginWithRedirect();
    document.getElementById("logoutBtn").onclick = () => window.auth0Client?.logout({
      logoutParams: { returnTo: window.location.origin + "/login.html" }
    });
    document.getElementById("loginBtn").style.display  = authed ? "none" : "";
    document.getElementById("logoutBtn").style.display = authed ? "" : "none";

    // optional: show claims button
    document.getElementById('showClaimsBtn').onclick = async () => {
      try {
        const t = await window.auth0Client.getTokenSilently();
        const body = JSON.parse(atob(t.split('.')[1]));
        const pre = document.getElementById('claims');
        pre.hidden = false;
        pre.textContent = JSON.stringify(body, null, 2);
      } catch (e) {
        console.error("getTokenSilently error:", e);
        set('status', 'Could not get token (see console).', false);
      }
    };
  }

  // wait for full page load so the SDK is parsed
  window.addEventListener("load", init);
</script>
